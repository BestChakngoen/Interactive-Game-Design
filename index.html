<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monster Catch Arena - Earth Tone Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap');

        :root {
            --p1-color: #a3b18a; /* Sage Green */
            --p2-color: #bc6c25; /* Terracotta */
            --bg-color: #fefae0; /* Creamy Sand */
            --text-color: #283618; /* Dark Forest */
            --accent-color: #dda15e; /* Earthy Gold */
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        .led-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 12px;
            padding: 15px;
            background: #ffffff;
            border-radius: 28px;
            box-shadow: 0 8px 30px rgba(40, 54, 24, 0.1);
        }

        .tile {
            background: #f1ede1;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(0,0,0,0.03);
        }

        .tile:hover { background: #e7e2d1; }
        .tile:active { transform: scale(0.92); }

        .monster {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 70%;
            height: 70%;
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            pointer-events: none;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1));
        }

        @keyframes bounceIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            70% { transform: translate(-50%, -50%) scale(1.15); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .monster.despawn { animation: bounceOut 0.2s forwards; }
        @keyframes bounceOut { to { transform: translate(-50%, -50%) scale(0); opacity: 0; } }

        .phase-banner {
            background: #ffffff;
            padding: 10px 30px;
            border-radius: 60px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 2px solid var(--text-color);
            transition: all 0.5s ease;
        }

        .phase-1 { border-color: #a3b18a; color: #588157; }
        .phase-2 { border-color: #dda15e; color: #bc6c25; }
        .phase-3 { border-color: #606c38; color: #283618; background: #e9edc9; animation: pulse 1.2s infinite; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        .lane-p1 { border: 4px solid var(--p1-color); background: #f0f2ea; }
        .lane-p2 { border: 4px solid var(--p2-color); background: #fdf5eb; }

        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            animation: explode 0.7s ease-out forwards;
        }

        @keyframes explode {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- Earthy Header -->
    <header class="h-28 bg-white/60 backdrop-blur-md flex justify-between items-center px-6 md:px-16 shadow-sm z-10 relative border-b border-stone-200">
        <!-- P1 Score -->
        <div class="flex flex-col items-center w-1/4">
            <span class="text-xs font-bold uppercase tracking-widest opacity-60">Forest Team (P1)</span>
            <div id="score-p1" class="text-4xl md:text-6xl font-black text-[#588157]">0</div>
        </div>

        <!-- Center Controls -->
        <div class="flex flex-col items-center flex-1 gap-2">
            <div id="phase-container" class="phase-banner phase-1">
                <span id="phase-display" class="text-lg md:text-2xl font-bold uppercase tracking-tight">Phase 1: Sunrise</span>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="bg-stone-100 px-5 py-1 rounded-full border border-stone-200">
                    <span id="timer" class="text-xl font-mono font-bold text-stone-600">03:00</span>
                </div>
                <div id="game-controls" class="hidden flex gap-2">
                    <button id="ingame-settings-btn" class="p-2 hover:bg-stone-200 rounded-full transition text-stone-500">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path fill-rule="evenodd" d="M18.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.56-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" clip-rule="evenodd"/></svg>
                    </button>
                    <button id="quit-game-btn" class="p-2 hover:bg-stone-200 rounded-full transition text-stone-400">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- P2 Score -->
        <div class="flex flex-col items-center w-1/4">
            <span class="text-xs font-bold uppercase tracking-widest opacity-60">Mountain Team (P2)</span>
            <div id="score-p2" class="text-4xl md:text-6xl font-black text-[#bc6c25]">0</div>
        </div>
    </header>

    <main class="flex-1 flex p-4 gap-6 relative">
        <div class="flex-1 flex flex-col items-center justify-center">
            <div id="grid-p1" class="led-grid w-full max-w-[360px] aspect-[3/4] lane-p1"></div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center">
            <div id="grid-p2" class="led-grid w-full max-w-[360px] aspect-[3/4] lane-p2"></div>
        </div>

        <!-- PAUSE LABEL -->
        <div id="pause-indicator" class="hidden absolute inset-0 z-40 flex items-center justify-center bg-stone-900/10 backdrop-blur-[2px]">
             <div class="bg-white/90 px-10 py-5 rounded-[30px] border-2 border-stone-200 shadow-xl">
                <h2 class="text-2xl font-bold text-stone-600 uppercase tracking-widest">Game Paused</h2>
             </div>
        </div>

        <!-- MAIN MENU -->
        <div id="menu-overlay" class="absolute inset-0 bg-[#fefae0] z-50 flex flex-col items-center justify-center p-8 text-center">
            <div class="mb-10">
                <h1 class="text-5xl md:text-7xl font-black text-[#283618] tracking-tight mb-4">Earth<br><span class="text-[#bc6c25]">Catchers</span></h1>
                <p class="text-stone-500 font-medium">‡∏™‡∏ô‡∏∏‡∏Å‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ï‡∏±‡∏ß‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏ô‡∏ò‡∏µ‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥</p>
            </div>

            <div class="flex gap-6 mb-12">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center w-24">
                    <span class="text-4xl mb-2">üê∞</span>
                    <span class="text-[10px] font-bold text-[#588157] uppercase">+15 pts</span>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center w-24">
                    <span class="text-4xl mb-2">üêû</span>
                    <span class="text-[10px] font-bold text-[#bc6c25] uppercase">+40 pts</span>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-stone-100 flex flex-col items-center w-24">
                    <span class="text-4xl mb-2">üåø</span>
                    <span class="text-[10px] font-bold text-stone-400 uppercase">-10 pts</span>
                </div>
            </div>

            <button id="start-btn" class="px-14 py-5 bg-[#606c38] hover:bg-[#283618] text-white rounded-full text-2xl font-bold shadow-lg shadow-stone-300 transition-all active:scale-95 uppercase mb-8">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢
            </button>
            
            <button id="open-settings-btn" class="text-stone-400 font-bold hover:text-stone-600 transition uppercase text-xs flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.56-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ô‡∏≤‡∏°
            </button>
        </div>

        <!-- SETTINGS -->
        <div id="settings-overlay" class="hidden absolute inset-0 bg-[#fefae0]/98 z-[60] flex flex-col items-center justify-center p-6">
            <div class="bg-white p-8 rounded-[40px] w-full max-w-md shadow-2xl border border-stone-100 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-stone-700 uppercase tracking-wide">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏°</h2>
                    <span id="settings-pause-tag" class="hidden text-[10px] bg-stone-500 text-white px-3 py-1 rounded-full font-bold">PAUSED</span>
                </div>
                
                <div class="space-y-5">
                    <!-- General Game Settings -->
                    <div class="pb-4 border-b border-stone-100">
                        <h3 class="text-[10px] font-bold text-stone-300 uppercase mb-4">‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏Å‡∏°</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-bold text-stone-500">‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                                <input type="number" id="input-duration" value="180" class="w-24 bg-stone-50 border border-stone-200 rounded-xl p-2 font-bold text-center text-stone-600 focus:outline-none focus:border-stone-400">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-bold text-stone-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î (ms)</label>
                                <input type="number" id="input-spawn-interval" value="1000" class="w-24 bg-stone-50 border border-stone-200 rounded-xl p-2 font-bold text-center text-stone-600 focus:outline-none focus:border-stone-400">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-bold text-stone-500">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏™‡∏î‡∏á (ms)</label>
                                <input type="number" id="input-lifetime" value="2000" class="w-24 bg-stone-50 border border-stone-200 rounded-xl p-2 font-bold text-center text-stone-600 focus:outline-none focus:border-stone-400">
                            </div>
                        </div>
                    </div>

                    <!-- Trickster Specific Settings -->
                    <div>
                        <h3 class="text-[10px] font-bold text-stone-300 uppercase mb-4">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Trickster (üåø)</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-bold text-stone-500">‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î (%)</label>
                                <input type="number" id="input-trickster-rate" value="20" min="0" max="100" class="w-24 bg-stone-50 border border-stone-200 rounded-xl p-2 font-bold text-center text-[#606c38] focus:outline-none focus:border-stone-400">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-bold text-stone-500">‡∏£‡∏∞‡∏¢‡∏∞‡πÅ‡∏™‡∏î‡∏á Trickster (ms)</label>
                                <div class="flex flex-col items-end">
                                    <input type="number" id="input-trickster-lifetime" value="1500" class="w-24 bg-stone-50 border border-stone-200 rounded-xl p-2 font-bold text-center text-[#606c38] focus:outline-none focus:border-stone-400">
                                    <span class="text-[9px] text-stone-400 mt-1">*‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏° Phase</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex gap-4">
                    <button id="close-settings-btn" class="flex-1 py-4 bg-stone-100 hover:bg-stone-200 rounded-2xl font-bold transition text-stone-500 uppercase text-xs">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="save-settings-btn" class="flex-1 py-4 bg-[#606c38] hover:bg-[#283618] text-white rounded-2xl font-bold transition uppercase text-xs shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤</button>
                </div>
            </div>
        </div>

        <!-- RESULTS -->
        <div id="result-overlay" class="hidden absolute inset-0 bg-[#fefae0] z-[70] flex flex-col items-center justify-center p-8 text-center">
            <h2 class="text-5xl font-black text-stone-800 mb-10 uppercase">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß!</h2>
            <div class="flex gap-16 mb-12">
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-stone-400 uppercase mb-2">Forest Team</span>
                    <span id="final-score-p1" class="text-7xl font-black text-[#588157]">0</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-stone-400 uppercase mb-2">Mountain Team</span>
                    <span id="final-score-p2" class="text-7xl font-black text-[#bc6c25]">0</span>
                </div>
            </div>
            <div id="winner-text" class="text-3xl font-black text-stone-600 mb-12"></div>
            <button onclick="location.reload()" class="px-14 py-4 bg-stone-800 text-white rounded-full text-xl font-bold hover:bg-stone-900 transition active:scale-95">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        </div>
    </main>

    <script>
        // --- GAME LOGIC ---
        let GAME_CONFIG = {
            duration: 180, 
            spawnInterval: 1000, 
            monsterLifetime: 2000,
            tricksterRate: 20, 
            tricksterLifetime: 1500, // Fixed Lifetime for Trickster
            gridRows: 4, gridCols: 3,
            scores: { normal: 15, rare: 40, trickster: -10 }
        };

        let state = {
            timeRemaining: GAME_CONFIG.duration,
            isPlaying: false, isPaused: false, phase: 1,
            p1: { score: 0, activeTiles: {} },
            p2: { score: 0, activeTiles: {} }
        };

        let timerInterval, botInterval, spawnTimeout;

        const gridP1 = document.getElementById('grid-p1');
        const gridP2 = document.getElementById('grid-p2');
        const phaseDisplay = document.getElementById('phase-display');
        const phaseContainer = document.getElementById('phase-container');
        const timerEl = document.getElementById('timer');
        const pauseIndicator = document.getElementById('pause-indicator');

        const Emojis = { normal: `üê∞`, rare: `üêû`, trickster: `üåø` };

        function createGrid(el, pKey) {
            el.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.onclick = (e) => handleInteraction(pKey, i, e);
                el.appendChild(tile);
            }
        }
        createGrid(gridP1, 'p1');
        createGrid(gridP2, 'p2');

        function togglePause(forced) {
            if (!state.isPlaying) return;
            state.isPaused = forced !== undefined ? forced : !state.isPaused;
            if (state.isPaused) {
                clearInterval(timerInterval); clearInterval(botInterval); clearTimeout(spawnTimeout);
                pauseIndicator.classList.remove('hidden');
                document.getElementById('settings-pause-tag').classList.remove('hidden');
            } else {
                startLoops();
                pauseIndicator.classList.add('hidden');
                document.getElementById('settings-pause-tag').classList.add('hidden');
            }
        }

        function updatePhase() {
            const ratio = state.timeRemaining / GAME_CONFIG.duration;
            let newPhase = 1, text = "Phase 1: Sunrise", cls = "phase-1";
            if (ratio < 0.3) { newPhase = 3; text = "Phase 3: Sunset Chaos"; cls = "phase-3"; }
            else if (ratio < 0.6) { newPhase = 2; text = "Phase 2: Active Forest"; cls = "phase-2"; }
            if (state.phase !== newPhase) {
                state.phase = newPhase;
                phaseContainer.className = `phase-banner ${cls}`;
                phaseDisplay.textContent = text;
            }
        }

        function handleInteraction(pKey, idx, e) {
            if (!state.isPlaying || state.isPaused || !state[pKey].activeTiles[idx]) return;
            const data = state[pKey].activeTiles[idx];
            state[pKey].score += GAME_CONFIG.scores[data.type];
            const rect = e.target.getBoundingClientRect();
            createParticles(e.clientX || rect.left + rect.width/2, e.clientY || rect.top + rect.height/2, data.type);
            if (data.type === 'trickster') {
                const grid = pKey === 'p1' ? gridP1 : gridP2;
                grid.classList.add('shake'); setTimeout(() => grid.classList.remove('shake'), 400);
            }
            document.getElementById(`score-${pKey}`).textContent = state[pKey].score;
            removeMonster(pKey, idx);
        }

        function trySpawn(pKey) {
            if (Object.keys(state[pKey].activeTiles).length >= 5) return;
            const idx = Math.floor(Math.random() * 12);
            if (state[pKey].activeTiles[idx]) return;
            let type = 'normal', r = Math.random() * 100;
            if (r < GAME_CONFIG.tricksterRate) type = 'trickster';
            else if (r > 88) type = 'rare';
            
            const m = document.createElement('div');
            m.className = 'monster flex items-center justify-center text-4xl';
            m.textContent = Emojis[type];
            (pKey === 'p1' ? gridP1 : gridP2).children[idx].appendChild(m);
            state[pKey].activeTiles[idx] = { type, el: m };
            
            // LOGIC: Normal/Rare duration decreases with phase, Trickster is FIXED
            let life = 0;
            if (type === 'trickster') {
                life = GAME_CONFIG.tricksterLifetime; // Fixed lifetime as requested
            } else {
                life = GAME_CONFIG.monsterLifetime / (state.phase * 0.85); // Dynamic lifetime
            }
            
            setTimeout(() => removeMonster(pKey, idx), life);
        }

        function removeMonster(pKey, idx) {
            const data = state[pKey].activeTiles[idx];
            if (!data) return;
            data.el.classList.add('despawn');
            setTimeout(() => { if(data.el.parentNode) data.el.remove(); }, 200);
            delete state[pKey].activeTiles[idx];
        }

        function createParticles(x, y, type) {
            const colors = type === 'rare' ? ['#dda15e', '#bc6c25'] : (type === 'trickster' ? ['#606c38', '#283618'] : ['#a3b18a', '#588157']);
            for (let i = 0; i < 6; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                p.style.left = x + 'px'; p.style.top = y + 'px';
                const a = Math.random() * Math.PI * 2, d = 30 + Math.random() * 40;
                p.style.setProperty('--tx', Math.cos(a) * d + 'px');
                p.style.setProperty('--ty', Math.sin(a) * d + 'px');
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 700);
            }
        }

        function startLoops() {
            timerInterval = setInterval(() => {
                state.timeRemaining--;
                const m = Math.floor(state.timeRemaining / 60), s = state.timeRemaining % 60;
                timerEl.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                updatePhase();
                if (state.timeRemaining <= 0) endGame();
            }, 1000);
            const spawnTicker = () => {
                if (!state.isPlaying || state.isPaused) return;
                trySpawn('p1'); trySpawn('p2');
                spawnTimeout = setTimeout(spawnTicker, (GAME_CONFIG.spawnInterval / (state.phase * 0.9)) * (0.8 + Math.random()*0.4));
            };
            spawnTicker();
            botInterval = setInterval(() => {
                if (state.isPaused) return;
                const keys = Object.keys(state.p2.activeTiles);
                if (keys.length > 0) {
                    const k = keys[Math.floor(Math.random() * keys.length)];
                    const monster = state.p2.activeTiles[k];
                    // Bot logic: avoid trickster if possible
                    if (monster.type !== 'trickster' || Math.random() < 0.1) {
                        handleInteraction('p2', k, { target: gridP2.children[k], clientX: 0, clientY: 0 });
                    }
                }
            }, 1400 / state.phase);
        }

        function startGame() {
            state.isPlaying = true;
            document.getElementById('menu-overlay').classList.add('hidden');
            document.getElementById('game-controls').classList.remove('hidden');
            startLoops();
        }

        function endGame() {
            state.isPlaying = false;
            clearInterval(timerInterval); clearInterval(botInterval); clearTimeout(spawnTimeout);
            document.getElementById('result-overlay').classList.remove('hidden');
            document.getElementById('final-score-p1').textContent = state.p1.score;
            document.getElementById('final-score-p2').textContent = state.p2.score;
            const w = document.getElementById('winner-text');
            if (state.p1.score > state.p2.score) w.textContent = "Forest Team Wins!";
            else if (state.p2.score > state.p1.score) w.textContent = "Mountain Team Wins!";
            else w.textContent = "Nature is Balanced!";
        }

        // Listeners
        document.getElementById('start-btn').onclick = startGame;
        document.getElementById('open-settings-btn').onclick = () => { togglePause(true); document.getElementById('settings-overlay').classList.remove('hidden'); };
        document.getElementById('ingame-settings-btn').onclick = () => { togglePause(true); document.getElementById('settings-overlay').classList.remove('hidden'); };
        document.getElementById('close-settings-btn').onclick = () => { document.getElementById('settings-overlay').classList.add('hidden'); togglePause(false); };
        document.getElementById('quit-game-btn').onclick = () => { togglePause(true); if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) location.reload(); else togglePause(false); };
        
        document.getElementById('save-settings-btn').onclick = () => {
            GAME_CONFIG.duration = parseInt(document.getElementById('input-duration').value);
            GAME_CONFIG.spawnInterval = parseInt(document.getElementById('input-spawn-interval').value);
            GAME_CONFIG.monsterLifetime = parseInt(document.getElementById('input-lifetime').value);
            GAME_CONFIG.tricksterRate = parseInt(document.getElementById('input-trickster-rate').value);
            GAME_CONFIG.tricksterLifetime = parseInt(document.getElementById('input-trickster-lifetime').value);
            
            // Reset state timer for duration changes if not started
            if (!state.isPlaying) state.timeRemaining = GAME_CONFIG.duration;
            
            document.getElementById('settings-overlay').classList.add('hidden');
            togglePause(false);
        };
    </script>
</body>
</html>
